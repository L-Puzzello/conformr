---
title: "dev-notes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dev-notes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dplyr)
```

# Prototype
## Data 
```{r test-data}
## make test data
origin_codes <- c("x001", "x002", "x003", "x004")
cases <- list(ABC = tibble(code_o = origin_codes,
                           value_o = rep(10, length(origin_codes))
),
XYZ = tibble(code_o = origin_codes,
             value_o = rep(100, length(origin_codes))
)
)

(df_origin <- cases %>% bind_rows(.id = "case"))

## make test correspondence table
df_codes <- tribble(~code_d, ~code_o,
                    "A1", "x001", # one-to-one
                    "B2", "x002", # many-to-one
                    "B2", "x003", # one-to-many
                    "C3", "x004",
                    "C4", "x004",
                    "C5", "x004",
                    "C6", "x004")

## generate default weights
(df_weights <- df_codes %>%
    # ---- make_weights() ----
  group_by(code_o) %>%
    mutate(n_dest = n_distinct(code_d),
           weight = 1/n_dest) %>%
    ungroup())
```

## Script conversion
```{r apply-transformation}
## intermediate merge
(df_merged <- df_origin %>%
  right_join(x = .,
             y = df_weights,
             by = c("code_o")) %>%
  mutate(weight_value = weight * value_o)
)

## final data
(df_convert_script <- df_origin %>%
  group_by(case) %>%
  # ---- IN convert() ----
  right_join(x = .,
             y = df_weights,
             by = c("code_o")) %>%
  mutate(weight_value = weight * value_o) %>%
  group_by(code_d, .add = TRUE) %>%
  summarise(target_value = sum(weight_value))
  # ---- OUT convert() ----
)
```

## `convert()` vs. script
```{r use-pkg-fnc}
df_convert_fnc <- df_origin %>%
  group_by(case) %>%
  conformr::convert(., df_weights, 
                    code_from = "code_o", code_to = "code_d",
                    values_from = "value_o", values_to = "target_value", 
                    weight_col = "weight")

assertthat::are_equal(df_convert_script, df_convert_fnc)
```


# Function Architecture
## Input tests
* `df_codes` has no duplication if used for making weights.
```{r draft-tests}

## check every origin value has somewhere to go
all(unique(df_origin$code_o) %in% unique(df_weights$code_o))
## check weights on origin values sum to 1 for each origin code
### conversation of value
df_weights %>%
  group_by(code_o) %>%
  summarise(total_w = sum(weight)) %>%
  filter(total_w != 1)
```

```{r draft-messages}
## flag if any origin values need spliting
if(any(df_weights$n_dest != 1)){
  message("some origin values will be split")
}




```

## Default corrections?
### Missing correspondences in `code_dict`
```{r}
## no duplicate information
## TODO: test data
nrow(df_codes) == nrow(distinct(df_codes))
```
* `distinct()` --> remove duplicate entries with the same info

### Missing weights in `code_dict`
* `weights` cant be empty
* [] generate default `weights`
* check `weights` sum to 1 for each unique `from`



